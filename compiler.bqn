âŸ¨
  Lex
âŸ©â‡

# This is a full monkey lang tokenizer based on chapter 1 of the book (so no string or comments).
Lexâ†{
    srcâ†ğ•©
    # Get all the letters, their first index, and the length of chains
    azâ†('_'âŠ¸=âˆ¨('a'âŠ¸â‰¤âˆ§â‰¤âŸœ'z')âˆ¨('A'âŠ¸â‰¤âˆ§â‰¤âŸœ'Z')) src
    fazâ†Â»âŠ¸<âŠ¢az
    lazâ†-ËœËË˜âˆ˜â€¿2â¥Š/0(âˆ¾â‰ âˆ¾Ëœ)az

    # Do the same thing to get all of the numbers
    numâ†('0'âŠ¸â‰¤âˆ§â‰¤âŸœ'9') src
    fnumâ†Â»âŠ¸<num
    lnumâ†-ËœËË˜âˆ˜â€¿2â¥Š/0(âˆ¾â‰ âˆ¾Ëœ)num

    # Match all of the keywords
    kwsâ†"fn"â€¿"let"â€¿"true"â€¿"false"â€¿"if"â€¿"else"â€¿"return"
    iazâ†/faz
    kwiâ†{
      lâ†â‰ kwâ†ğ•©
      piâ†iaz/Ëœl=laz
      {kwâ‰¡lâ†‘ğ•©â†“src}Â¨âŠ¸/pi
    }Â¨kws

    # Extract keyword types into full array.
    kwmâ†1+â†•â‰ kwi
    kwtâ†+Â´kwmÃ—(â‰ src)âŠ¸â†‘âˆ˜(/â¼)Â¨kwi

    # Only match the first `!=` or `==` in a chain.
    # Repeats will be invalid syntax anyway.
    # So it is fine to parse `====` as `==` `=` `=`.
    nâ€¿eâ†â‹ˆË"!="=âŒœsrc
    onâ€¿oeâ†nâ€¿e
    fneâ†e(âŠ¢âˆ§Â«âˆ˜âˆ§âŸœÂ»)n
    n âˆ§â†© Â¬fne
    e âˆ§â†© Â¬Â»fne
    feeâ†(Â«âˆ§âŠ¢>Â»)e
    e âˆ§â†© (Â¬Â»âˆ¨âŠ¢)fee

    # All other symbols are just single characters.
    tcâ†"+-/*<>;,(){}"
    fcâ†nâˆ¨eâˆ¨tcâˆŠËœsrc

    # Get all illegal tokens
    fxâ†Â¬azâˆ¨numâˆ¨fcâˆ¨onâˆ¨oeâˆ¨srcâˆŠ@+9â€¿10â€¿13â€¿32

    fkwâ†kwtâ‰ 0

    # Final format
    # First array is i: ident, k: keyword, 0: number, e: equals, n: not equals, x: illegal, other tokens: themselves
    # Second array is the index in the original src (This will be used to extract identifiers later).
    # It also could be used for nice error messages.
    # The last array is miscellaneous data.
    # For keywords, it is the keyword type: 1: fn, 2: let, 3: true, 4: false, 5: if, 6: else, 7: return
    # For identifiers and numbers, it is the length of the indentifier.

    fmâ†fazâˆ¨fnumâˆ¨fkwâˆ¨fneâˆ¨feeâˆ¨fcâˆ¨fx
    fâ†/fm

    # fc does not update tt becuase characters stay as their oringal value.
    ttâ†"ki0nex "âŠËœ+Â´âˆ§`Â¬fkwâ€¿fazâ€¿fnumâ€¿fneâ€¿feeâ€¿fx
    ttâ†©fm/srcâŠ£âŒ¾((' '=tt)âŠ¸/)tt

    ffazâ†fm/faz
    ffnumâ†fm/fnum
    ffkwâ†fm/fkw
    dâ†0Â¨tt
    d lazâŒ¾(ffazâŠ¸/)â†©
    d lnumâŒ¾(ffnumâŠ¸/)â†©
    d (fkw/kwt)âŒ¾(ffkwâŠ¸/)â†©

    ttâ€¿fâ€¿d
}
